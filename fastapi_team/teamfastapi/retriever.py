# ì„ë² ë”© ëª¨ë¸ ì„ ì–¸í•˜ê¸°
from langchain_openai import OpenAIEmbeddings

# í…ìŠ¤íŠ¸ë¥¼ ë²¡í„°ë¡œ ë³€í™˜í•  Embedding ëª¨ë¸ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
embedding = OpenAIEmbeddings(model='text-embedding-3-large')

# ì–¸ì–´ ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ê¸°
from langchain_openai import ChatOpenAI

# ì§ˆë¬¸ì— ë‹µë³€í•˜ê±°ë‚˜ í”„ë¡¬í”„íŠ¸ë¥¼ ì²˜ë¦¬í•  ëŒ€í™”í˜• LLMì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
llm = ChatOpenAI(model="gpt-4o-mini")

# Chroma ë²¡í„°ìŠ¤í† ì–´ ë¡œë“œ
from langchain_community.vectorstores import Chroma 

# ì €ì¥ëœ ë²¡í„° ë°ì´í„°ê°€ ìˆëŠ” ë””ë ‰í„°ë¦¬ ê²½ë¡œ ì§€ì •
persist_directory = 'C:/kd/ws_python/fastapi_team/teamfastapi/chroma_db_langchain'

# Chroma ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ ì €ì¥ëœ ë²¡í„°ìŠ¤í† ì–´ì— ì ‘ê·¼í•©ë‹ˆë‹¤.
vectorstore = Chroma(
    persist_directory=persist_directory, # ì„ë² ë”©ë˜ì–´ ì €ì¥ëœ í´ë”
    embedding_function=embedding  # ê²€ìƒ‰ ì‹œ ì‚¬ìš©í•  ì„ë² ë”© ëª¨ë¸ ì§€ì •
)

# ê²€ìƒ‰ê¸°(retriever) ìƒì„±: k=1 ì´ë¯€ë¡œ, ìœ ì‚¬ ë¬¸ì„œ ìƒìœ„ 1ê°œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
retriever = vectorstore.as_retriever(k=1)

# ë¬¸ì„œ QA ì²´ì¸ ìƒì„±
from langchain.chains.combine_documents import create_stuff_documents_chain
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.output_parsers import StrOutputParser  # ì¶œë ¥ê°’ì„ ë¬¸ìì—´ë¡œ íŒŒì‹±

# ------------------------------------------------------------------------------------------------
# í”„ë¡¬í”„íŠ¸ë¥¼ ì‹¤í–‰í•˜ëŠ” Chain 1
# ------------------------------------------------------------------------------------------------
# ì‹œìŠ¤í…œ ë©”ì‹œì§€ì™€ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ í•©ì³ì„œ í”„ë¡¬í”„íŠ¸ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.
question_answering_prompt = ChatPromptTemplate.from_messages(
    [
        MessagesPlaceholder(variable_name="messages"),
        (
            "system",
            "ì•„ë˜ contextëŠ” íŠ¹ìˆ˜ ë°˜ë ¤ë™ë¬¼ì— ëŒ€í•œ ì„¤ëª…ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹¤ìŒ ì§€ì¹¨ì„ ë”°ë¼ ë‹µë³€í•˜ì‹­ì‹œì˜¤:\n\n"
            "1. ì§ˆë¬¸ì—ì„œ ì–¸ê¸‰ëœ ë°˜ë ¤ë™ë¬¼ ì¢…(species)ê³¼ í•­ëª©(category: ì‚¬ìœ¡í™˜ê²½, ë¨¹ì´, ìŠµì„±, ì£¼ì˜í•  ì  ë“±)ì„ ì •í™•íˆ íŒŒì•…í•©ë‹ˆë‹¤.\n"
            "2. contextì—ì„œ í•´ë‹¹ ì¢…ê³¼ í•­ëª©ì´ ì¡´ì¬í•  ê²½ìš°, **í•´ë‹¹ í•­ëª©ì˜ ì •ë³´ë§Œ** ìš”ì•½í•´ ì‘ë‹µí•©ë‹ˆë‹¤.\n"
            "3. í•˜ë‚˜ì˜ ì¢…ì— ëŒ€í•´ ì—¬ëŸ¬ í•­ëª©ì„ ì§ˆë¬¸í•œ ê²½ìš°ëŠ” ê°ê° ë‚˜ëˆ ì„œ ì‘ë‹µí•©ë‹ˆë‹¤.\n"
            "4. contextì— í•´ë‹¹ ì¢… ë˜ëŠ” í•­ëª©ì´ ì—†ëŠ” ê²½ìš°, ì¼ë°˜ì ì¸ íŠ¹ìˆ˜ë°˜ë ¤ë™ë¬¼ ê¸°ì¤€ìœ¼ë¡œ ê°„ë‹¨íˆ ì„¤ëª…í•©ë‹ˆë‹¤. \n"
            "   **ì ˆëŒ€ ì•„ë˜ì™€ ê°™ì€ í‘œí˜„ì€ ì‚¬ìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤:**\n"
            "   - 'ì •ë³´ê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤'\n"
            "   - 'ì œê³µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'\n"
            "   - 'ê´€ë ¨ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤'\n"
            "   - 'ì•Œë ¤ì§„ ë°” ì—†ìŠµë‹ˆë‹¤'\n"
            "   - 'íŠ¹ì • ì •ë³´ë¥¼ ì œê³µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'\n"
            "   - ì´ì™€ ìœ ì‚¬í•œ 'ì •ë³´ ì—†ìŒ'ì„ ì•”ì‹œí•˜ëŠ” í‘œí˜„ ì¼ì²´\n"
            "   ğŸ‘‰ ì´ í‘œí˜„ì´ í¬í•¨ë˜ë©´ ë¬´ì¡°ê±´ ì˜ëª»ëœ ì‘ë‹µì…ë‹ˆë‹¤.\n"
            "5. ë¬´ì¡°ê±´ ì‹¤ì œ ì„¤ëª…ë¶€í„° ì‹œì‘í•˜ì‹­ì‹œì˜¤. ë¶ˆí•„ìš”í•œ ì „ì œ, ì¸ì‚¬ë§, ì „ì²´ ìš”ì•½, ë°˜ë³µ í‘œí˜„ì€ ìƒëµí•˜ê³  **ê°„ê²°í•˜ê²Œ í•µì‹¬ë§Œ** ì „ë‹¬í•˜ì‹­ì‹œì˜¤.\n"
            "context:\n{context}"
        ),
    ]
)


# LLMê³¼ í”„ë¡¬í”„íŠ¸, ì¶œë ¥ íŒŒì„œë¥¼ ì—°ê²°í•´ í•˜ë‚˜ì˜ ì²´ì¸ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤. ê²°ê³¼ëŠ” ë¬¸ìì—´ ì¶œë ¥
# create_stuff_documents_chain í•¨ìˆ˜ ì‚¬ìš©ì‹œ contextê°€ ë°˜ë“œì‹œ ìˆì–´ì•¼í•¨.
document_chain = create_stuff_documents_chain(llm, question_answering_prompt) | StrOutputParser()

# ------------------------------------------------------------------------------------------------
# í”„ë¡¬í”„íŠ¸ë¥¼ ì‹¤í–‰í•˜ëŠ” Chain 2, ì‚¬ìš©ìì˜ ì§ˆë¬¸ íë¦„ëŒ€ë¡œ í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ì •í•¨
# ------------------------------------------------------------------------------------------------
# ì§ˆì˜ ë³´ê°•(query augmentation) ì²´ì¸ ìƒì„±
query_augmentation_prompt = ChatPromptTemplate.from_messages(
    [
        MessagesPlaceholder(variable_name="messages"),  # ê¸°ì¡´ ëŒ€í™” ë‚´ìš©
        (
            "system",
            "ê¸°ì¡´ì˜ ëŒ€í™” ë‚´ìš©ì„ í™œìš©í•˜ì—¬ ì‚¬ìš©ìì˜ ì•„ë˜ ì§ˆë¬¸ì˜ ì˜ë„ë¥¼ íŒŒì•…í•˜ì—¬ "
            "ëª…ë£Œí•œ ë¬¸ì¥ì˜ ì§ˆë¬¸ìœ¼ë¡œ ë³€í™˜í•˜ë¼.\n\n{query}"
        ),
    ]
)
# ë³´ê°•ëœ í”„ë¡¬í”„íŠ¸ë¥¼ LLMê³¼ ì—°ê²°í•˜ê³ , ë¬¸ìì—´ë¡œ íŒŒì‹±í•©ë‹ˆë‹¤.
query_augmentation_chain = query_augmentation_prompt | llm | StrOutputParser()

# ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ AI ê¸°ëŠ¥ì„ í™œì„±í™”í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ í˜¸ì¶œí•©ë‹ˆë‹¤.