<!DOCTYPE html>

<html layout:decorate="~{layout}"> <!-- layout.html ìƒì†-->
<th:block layout:fragment="styles">
  <link rel="stylesheet" href="/css/signup.css">
</th:block>

<div layout:fragment="content">
  <script>
  const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    window.onload = () => {
      document.getElementById('btn_send').addEventListener('click', send);

      document.querySelector('#current_passwd').addEventListener('keypress', (event) => {
        // document.getElementById('passwd').addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          document.getElementById('passwd').focus();
        }
      });

      document.querySelector('#passwd').addEventListener('keypress', (event) => {
        // document.getElementById('passwd').addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          document.getElementById('passwd2').focus();
        }
      });

      document.querySelector('#passwd2').addEventListener('keypress', (event) => {
        // document.getElementById('passwd').addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          document.getElementById('btn_send').focus();
        }
      });

    }

     function send() {
      let url = './passwd_check';
      let passwd = document.getElementById("current_passwd").value;
    
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          [csrfHeader]: csrfToken
        },
        body: JSON.stringify({ current_passwd: passwd })
      })
        .then(response => response.json())
        .then(rdata => {
          if (rdata.cnt == 0) {
            current_passwd_msg.innerHTML = 'âŒ í˜„ì¬ íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            current_passwd_msg.classList.add('span_warning');
            current_passwd.focus();
            return;
          }
    
          current_passwd_msg.innerHTML = ''; // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
    
          let passwd = document.getElementById('passwd');
          let passwd2 = document.getElementById('passwd2');
          let passwd2_msg = document.getElementById('passwd2_msg');
    
          if (passwd.value !== passwd2.value) {
            passwd2_msg.innerHTML = 'âŒ ì…ë ¥ëœ íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
            passwd2_msg.classList.add('span_warning');
            passwd.focus();
            return;
          }
    
          // âœ… í¼ ë°©ì‹ìœ¼ë¡œ ì „ì†¡
          document.getElementById('frm').submit();
        })
        .catch(error => {
          console.error('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì˜¤ë¥˜:', error);
          const msgBox = document.getElementById('passwd_error_msg');
          msgBox.innerHTML = 'âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          msgBox.classList.add('span_warning');
        });
    
      current_passwd_msg.innerHTML = "<img src='/images/progress.gif' style='width: 5%;'>";
    }


  </script>

  <div class="passwd-wrapper">

    <!-- âœ… ì œëª© -->
    <div class="passwd-header">
      <h2 class="passwd-title">ğŸ”’ íŒ¨ìŠ¤ì›Œë“œ ë³€ê²½</h2>
    </div>

    <!-- âœ… ë©”ì¸ í¼ -->
    <div class="passwd-card">
      <form id="frm" name="frm" th:object="${usersVO}" method="post" action="/users/passwd_update_proc"
        class="passwd-form">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <input type="hidden" name="usersno" th:value="${usersVO.usersno}">

        <div class="passwd-form-group">
          <label for="current_passwd">í˜„ì¬ íŒ¨ìŠ¤ì›Œë“œ*</label>
          <input type="password" id="current_passwd" name="current_passwd" placeholder="í˜„ì¬ íŒ¨ìŠ¤ì›Œë“œ" required />
          <div id="current_passwd_msg" class="passwd-msg"></div>
        </div>

        <div class="passwd-form-group">
          <label for="passwd">ìƒˆë¡œìš´ íŒ¨ìŠ¤ì›Œë“œ*</label>
          <input type="password" id="passwd" name="passwd" placeholder="ìƒˆë¡œìš´ íŒ¨ìŠ¤ì›Œë“œ" required />
        </div>

        <div class="passwd-form-group">
          <label for="passwd2">ìƒˆë¡œìš´ íŒ¨ìŠ¤ì›Œë“œ í™•ì¸*</label>
          <input type="password" id="passwd2" name="passwd2" placeholder="íŒ¨ìŠ¤ì›Œë“œ í™•ì¸" required />
          <div id="passwd2_msg" class="passwd-msg"></div>
        </div>

        <div class="passwd-button-group">
          <button type="button" id="btn_send" class="btn btn-filled">ì €ì¥</button>
          <button type="button" onclick="history.back();" class="btn btn-outline">ì·¨ì†Œ</button>
        </div>
      </form>
    </div>
  </div>


</html>