<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
  <title>íšŒì›ê°€ì…</title>
  <link rel="stylesheet" th:href="@{/css/signup.css}">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body>
  <div layout:fragment="content">

    <script>
      window.onload = () => {
        // 1) Enter í‚¤ë¡œ í¬ì»¤ìŠ¤ ì´ë™
        document.querySelector('#email').addEventListener('keypress', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('btn_checkEmail').focus();
          }
        });
        document.querySelector('#passwd').addEventListener('keypress', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('passwd2').focus();
          }
        });
        document.querySelector('#passwd2').addEventListener('keypress', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('usersname').focus();
          }
        });
        document.querySelector('#usersname').addEventListener('keypress', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('tel').focus();
          }
        });
        document.querySelector('#tel').addEventListener('keypress', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('btn_DaumPostcode').focus();
          }
        });
        document.querySelector('#address2').addEventListener('keypress', (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('btn_send').focus();
          }
        });

        // 2) ì¤‘ë³µí™•ì¸ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ ë°”ì¸ë”©
        const btn = document.getElementById('btn_checkEmail');
        console.log('btn_checkEmail ìš”ì†Œ:', btn);

        if (btn) {
          btn.addEventListener('click', () => {
            console.log('ğŸ”” ë²„íŠ¼ í´ë¦­ ê°ì§€, checkEmail í˜¸ì¶œ');
            checkEmail();
          });
        }

      }

      // ì¤‘ë³µ ì•„ì´ë”” ê²€ì‚¬
      function checkEmail() {
        console.log('ğŸ”” checkEmail() ì‹œì‘');

        const emailEl = document.getElementById('email');
        const msgEl = document.getElementById('email_msg');
        const email = emailEl.value.trim();

        if (email.length < 3) {
          msgEl.textContent = 'ID(ì´ë©”ì¼)ëŠ” ìµœì†Œ 3ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
          msgEl.className = 'msg span_warning';
          emailEl.focus();
          return false;
        }

        msgEl.innerHTML = "<img src='/images/progress.gif' style='width:5%'>";

        // ìƒëŒ€ê²½ë¡œë¡œ ìš”ì²­í•˜ë©´ context-path ë¬¸ì œë¥¼ í”¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        // checkEmail() ë‚´ë¶€ì—ì„œ URLì„ ì´ë ‡ê²Œ ë°”ê¿” ë³´ì„¸ìš”.
        const url = `/users/checkEmail?email=${encodeURIComponent(email)}`;

        console.log('â–¶ fetch ìš”ì²­ URL:', url);

        fetch(`/users/checkEmail?email=${encodeURIComponent(email)}`)
          .then(res => {
            console.log('ğŸ”” fetch ì‘ë‹µ status:', res.status);
            if (!res.ok) throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜ ' + res.status);
            return res.json();
          })
          .then(data => {
            console.log('ğŸ”” ì„œë²„ JSON ë°ì´í„°:', data);
            if (data.cnt > 0) {
              msgEl.textContent = 'ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ID(ì´ë©”ì¼)ì…ë‹ˆë‹¤.';
              msgEl.className = 'msg span_warning';
              emailEl.focus();
            } else {
              msgEl.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ID(ì´ë©”ì¼)ì…ë‹ˆë‹¤.';
              msgEl.className = 'msg span_info';
              document.getElementById('passwd').focus();
            }
          })
          .catch(err => {
            console.error('âŒ checkEmail ì˜¤ë¥˜:', err);
            msgEl.textContent = 'ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            msgEl.className = 'msg span_warning';
          });
      }
      const nameBtn = document.getElementById('btn_checkName');
      if (nameBtn) {
        nameBtn.addEventListener('click', () => {
          console.log('ğŸ”” ë²„íŠ¼ í´ë¦­ ê°ì§€, checkName í˜¸ì¶œ');
          checkName();
        });
      }

      // ìƒˆë¡œ ì¶”ê°€: ë‹‰ë„¤ì„ ì¤‘ë³µ ê²€ì‚¬
      function checkName() {
        console.log('ğŸ”” checkName() ì‹œì‘');

        const nameEl = document.getElementById('usersname');
        const msgEl = document.getElementById('usersname_msg');
        const name = nameEl.value.trim();

        if (name.length < 2) {
          msgEl.textContent = 'ë‹‰ë„¤ì„ì€ ìµœì†Œ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
          msgEl.className = 'msg span_warning';
          nameEl.focus();
          return false;
        }

        msgEl.innerHTML = "<img src='/images/progress.gif' style='width:5%'>";

        fetch(`/users/checkName?usersname=${encodeURIComponent(name)}`)
          .then(res => {
            if (!res.ok) throw new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ' + res.status);
            return res.json();
          })
          .then(data => {
            if (data.cnt > 0) {
              msgEl.textContent = 'ì´ë¯¸ ì‚¬ìš©ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
              msgEl.className = 'msg span_warning';
              nameEl.focus();
            } else {
              msgEl.textContent = 'ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
              msgEl.className = 'msg span_info';
              document.getElementById('tel').focus();
            }
          })
          .catch(err => {
            console.error(err);
            msgEl.textContent = 'ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            msgEl.className = 'msg span_warning';
          });
      }

      // íšŒì›ê°€ì… ì²˜ë¦¬
      function send() {
        const passwd = document.getElementById('passwd');
        const passwd2 = document.getElementById('passwd2');
        const passwd2_msg = document.getElementById('passwd2_msg');

        // ë¶ˆì¼ì¹˜í•˜ë©´
        if (passwd.value !== passwd2.value) {
          passwd2_msg.textContent = 'íŒ¨ìŠ¤ì›Œë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
          passwd2_msg.className = 'msg span_warning';
          passwd.focus();
          return false;   // â† ì—¬ê¸°ì„œ ë¹ ì ¸ë‚˜ì˜¤ë©´ì„œ ë©”ì‹œì§€ê°€ ë‚¨ì•„ì•¼ í•¨
        }

        // ëª¨ë‘ í†µê³¼í•˜ë©´
        document.getElementById('frm').submit();



        // 2) í•„ìˆ˜ ì•½ê´€ ë™ì˜ ê²€ì‚¬
        const termsChk = document.querySelector('input[name="terms"]');
        const privacyChk = document.querySelector('input[name="privacy"]');

        if (!termsChk.checked || !privacyChk.checked) {
          alert('í•„ìˆ˜ ì•½ê´€ì— ëª¨ë‘ ë™ì˜í•˜ì…”ì•¼ ê°€ì…ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
          (!termsChk.checked ? termsChk : privacyChk).focus();
          return false;
        }

        // 3) ëª¨ë‘ í†µê³¼í•˜ë©´ í¼ ì œì¶œ í—ˆìš©
        return true;
      }
    </script>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const agreeAll = document.getElementById('agree_all');
        // í•˜ìœ„ ì²´í¬ë°•ìŠ¤ë“¤ ì„ íƒ
        const childCheckboxes = document.querySelectorAll(
          'input[name="terms"], input[name="privacy"], input[name="marketing"]'
        );

        // 1) ë§ˆìŠ¤í„° í† ê¸€ â†’ í•˜ìœ„ ì¼ê´„ í† ê¸€
        agreeAll.addEventListener('change', () => {
          childCheckboxes.forEach(cb => {
            cb.checked = agreeAll.checked;
          });
        });

        // 2) ë§Œì•½ ì‚¬ìš©ìê°€ ê°œë³„ ì²´í¬ë°•ìŠ¤ë¥¼ ê±´ë“œë¦´ ë•Œ
        //    ëª¨ë‘ ì²´í¬ë˜ë©´ ë§ˆìŠ¤í„°ë„ ì²´í¬, í•˜ë‚˜ë¼ë„ í•´ì œë˜ë©´ ë§ˆìŠ¤í„° í•´ì œ
        childCheckboxes.forEach(cb => {
          cb.addEventListener('change', () => {
            const allChecked = Array.from(childCheckboxes).every(c => c.checked);
            agreeAll.checked = allChecked;
          });
        });
      });
    </script>

 <div class="signup-page">
    <div class="signup-section">
  <h1 class="signup-title">íšŒì›ê°€ì…</h1>

  <form name="frm" id="frm" th:object="${usersVO}" method="post" action="/users/create" onsubmit="return send()">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

    <div class="signup-container">

      <!-- âœ… ë¡œê·¸ì¸ ì •ë³´ -->
      <h2 class="section-title">ë¡œê·¸ì¸ ì •ë³´</h2>
      <div class="form-row">
        <label for="email">ì•„ì´ë””*</label>
        <div class="form-input-wrap">
          <input type="text" name="email" id="email" required placeholder="ì•„ì´ë””*" class="form-input" autofocus>
          <button type="button" id="btn_checkEmail" class="btn-sub">ì¤‘ë³µí™•ì¸</button>
        </div>
        <span id="email_msg" class="msg"></span>
      </div>

      <div class="form-row">
        <label for="passwd">íŒ¨ìŠ¤ì›Œë“œ*</label>
        <input type="password" name="passwd" id="passwd" required placeholder="íŒ¨ìŠ¤ì›Œë“œ*" class="form-input">
      </div>

      <div class="form-row">
        <label for="passwd2">íŒ¨ìŠ¤ì›Œë“œ í™•ì¸*</label>
        <input type="password" name="passwd2" id="passwd2" required placeholder="íŒ¨ìŠ¤ì›Œë“œ í™•ì¸*" class="form-input">
        <span id="passwd2_msg" class="msg"></span>
      </div>

      <!-- âœ… íšŒì› ì •ë³´ -->
      <h2 class="section-title">íšŒì› ì •ë³´</h2>

      <div class="form-row">
        <label for="usersname">ì´ë¦„(ë‹‰ë„¤ì„)*</label>
        <div class="form-input-wrap">
          <input type="text" name="usersname" id="usersname" required placeholder="ì´ë¦„(ë‹‰ë„¤ì„)*" class="form-input">
          <button type="button" id="btn_checkName" onclick="checkName()" class="btn-sub">ì¤‘ë³µí™•ì¸</button>
        </div>
        <span id="usersname_msg" class="msg"></span>
      </div>

      <div class="form-row">
        <label for="tel">ì „í™”ë²ˆí˜¸*</label>
        <input type="text" name="tel" id="tel" required placeholder="ì „í™”ë²ˆí˜¸*" class="form-input">
      </div>

      <div class="form-row">
        <label for="zipcode">ìš°í¸ë²ˆí˜¸</label>
        <div class="form-input-wrap">
          <input type="text" name="zipcode" id="zipcode" placeholder="ìš°í¸ë²ˆí˜¸" class="form-input">
          <button type="button" id="btn_DaumPostcode" onclick="DaumPostcode()" class="btn-sub">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
        </div>
      </div>
      
      <div>
        <div id="wrap" style="display:none;border:1px solid;width:500px;height:300px;margin:5px 0;position:relative">
        <img src="//t1.daumcdn.net/postcode/resource/images/close.png" id="btnFoldWrap" style="cursor:pointer;position:absolute;right:0px;top:-1px;z-index:1" onclick="foldDaumPostcode()" alt="ì ‘ê¸° ë²„íŠ¼">
      </div>
      
      <div class="form-row">
        <label for="address1">ì£¼ì†Œ</label>
        <input type="text" name="address1" id="address1" placeholder="ì£¼ì†Œ" class="form-input">
      </div>

      <div class="form-row">
        <label for="address2">ìƒì„¸ ì£¼ì†Œ</label>
        <input type="text" name="address2" id="address2" placeholder="ìƒì„¸ ì£¼ì†Œ" class="form-input">
      </div>

      <!-- âœ… ì•½ê´€ ë™ì˜ -->
      <h2 class="section-title">ê°€ì… ì•½ê´€ ë™ì˜</h2>
      <div class="terms-item">
        <label><input type="checkbox" id="agree_all"> ëª¨ë“  ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤.</label>
      </div>
      <div class="terms-item">
        <label><input type="checkbox" name="terms" required> ê°€ë¹„ì•„ ì´ìš© ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤. <span class="required">(í•„ìˆ˜)</span></label>
        <a href="#" class="details">ìƒì„¸ë³´ê¸° <span class="arrow">â–¾</span></a>
      </div>
      <div class="terms-item">
        <label><input type="checkbox" name="privacy" required> ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤. <span class="required">(í•„ìˆ˜)</span></label>
        <a href="#" class="details">ìƒì„¸ë³´ê¸° <span class="arrow">â–¾</span></a>
      </div>
      <div class="terms-item">
        <label><input type="checkbox" name="marketing"> ë§ˆì¼€íŒ… í™œìš© ìˆ˜ì‹ ì— ë™ì˜í•©ë‹ˆë‹¤. <span class="optional">(ì„ íƒ)</span></label>
        <a href="#" class="details">ìƒì„¸ë³´ê¸° <span class="arrow">â–¾</span></a>
      </div>

      <!-- âœ… ë²„íŠ¼ -->
      <div class="signup-actions">
        <button type="submit" id="btn_send" class="btn-main">ê°€ì…í•˜ê¸°</button>
        <button type="button" onclick="history.back();" class="btn-cancel">ì·¨ì†Œ</button>
      </div>
</div>
          <!-- ------------------------------ DAUM ìš°í¸ë²ˆí˜¸ API ì‹œì‘ ------------------------------ -->
          <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
          <script>
            // ìš°í¸ë²ˆí˜¸ ì°¾ê¸° ì°¾ê¸° í™”ë©´ì„ ë„£ì„ element
            var element_wrap = document.getElementById('wrap');

            function foldDaumPostcode() {
              // iframeì„ ë„£ì€ elementë¥¼ ì•ˆë³´ì´ê²Œ í•œë‹¤.
              element_wrap.style.display = 'none';
            }

            function DaumPostcode() {
              // í˜„ì¬ scroll ìœ„ì¹˜ë¥¼ ì €ì¥í•´ë†“ëŠ”ë‹¤.
              var currentScroll = Math.max(document.body.scrollTop, document.documentElement.scrollTop);
              new daum.Postcode({
                oncomplete: function (data) {
                  // ê²€ìƒ‰ê²°ê³¼ í•­ëª©ì„ í´ë¦­í–ˆì„ë•Œ ì‹¤í–‰í•  ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ë¶€ë¶„.

                  // ê° ì£¼ì†Œì˜ ë…¸ì¶œ ê·œì¹™ì— ë”°ë¼ ì£¼ì†Œë¥¼ ì¡°í•©í•œë‹¤.
                  // ë‚´ë ¤ì˜¤ëŠ” ë³€ìˆ˜ê°€ ê°’ì´ ì—†ëŠ” ê²½ìš°ì—” ê³µë°±('')ê°’ì„ ê°€ì§€ë¯€ë¡œ, ì´ë¥¼ ì°¸ê³ í•˜ì—¬ ë¶„ê¸° í•œë‹¤.
                  var addr = ''; // ì£¼ì†Œ ë³€ìˆ˜
                  var extraAddr = ''; // ì°¸ê³ í•­ëª© ë³€ìˆ˜

                  //ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œ íƒ€ì…ì— ë”°ë¼ í•´ë‹¹ ì£¼ì†Œ ê°’ì„ ê°€ì ¸ì˜¨ë‹¤.
                  if (data.userSelectedType === 'R') { // ì‚¬ìš©ìê°€ ë„ë¡œëª… ì£¼ì†Œë¥¼ ì„ íƒí–ˆì„ ê²½ìš°
                    addr = data.roadAddress;
                  } else { // ì‚¬ìš©ìê°€ ì§€ë²ˆ ì£¼ì†Œë¥¼ ì„ íƒí–ˆì„ ê²½ìš°(J)
                    addr = data.jibunAddress;
                  }

                  /*
                  // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œê°€ ë„ë¡œëª… íƒ€ì…ì¼ë•Œ ì°¸ê³ í•­ëª©ì„ ì¡°í•©í•œë‹¤.
                  if(data.userSelectedType === 'R'){
                      // ë²•ì •ë™ëª…ì´ ìˆì„ ê²½ìš° ì¶”ê°€í•œë‹¤. (ë²•ì •ë¦¬ëŠ” ì œì™¸)
                      // ë²•ì •ë™ì˜ ê²½ìš° ë§ˆì§€ë§‰ ë¬¸ìê°€ "ë™/ë¡œ/ê°€"ë¡œ ëë‚œë‹¤.
                      if(data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)){
                          extraAddr += data.bname;
                      }
                      // ê±´ë¬¼ëª…ì´ ìˆê³ , ê³µë™ì£¼íƒì¼ ê²½ìš° ì¶”ê°€í•œë‹¤.
                      if(data.buildingName !== '' && data.apartment === 'Y'){
                          extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                      }
                      // í‘œì‹œí•  ì°¸ê³ í•­ëª©ì´ ìˆì„ ê²½ìš°, ê´„í˜¸ê¹Œì§€ ì¶”ê°€í•œ ìµœì¢… ë¬¸ìì—´ì„ ë§Œë“ ë‹¤.
                      if(extraAddr !== ''){
                          extraAddr = ' (' + extraAddr + ')';
                      }
                      // ì¡°í•©ëœ ì°¸ê³ í•­ëª©ì„ í•´ë‹¹ í•„ë“œì— ë„£ëŠ”ë‹¤.
                      document.getElementById("sample3_extraAddress").value = extraAddr;
                  
                  } else {
                      document.getElementById("sample3_extraAddress").value = '';
                  }
                  */

                  // ìš°í¸ë²ˆí˜¸ì™€ ì£¼ì†Œ ì •ë³´ë¥¼ í•´ë‹¹ í•„ë“œì— ë„£ëŠ”ë‹¤.
                  document.getElementById('zipcode').value = data.zonecode; // ìš°í¸ë²ˆí˜¸
                  document.getElementById("address1").value = addr;  // ì£¼ì†Œ

                  document.getElementById("address2").innerHTML = ""; // ìƒì„¸ ì£¼ì†Œ ì§€ìš°ê¸°
                  // ì»¤ì„œë¥¼ ìƒì„¸ì£¼ì†Œ í•„ë“œë¡œ ì´ë™í•œë‹¤.
                  document.getElementById("address2").focus();  // ìƒì„¸ ì£¼ì†Œë¡œ í¬ì»¤ìŠ¤ ì´ë™

                  // iframeì„ ë„£ì€ elementë¥¼ ì•ˆë³´ì´ê²Œ í•œë‹¤.
                  // (autoClose:false ê¸°ëŠ¥ì„ ì´ìš©í•œë‹¤ë©´, ì•„ë˜ ì½”ë“œë¥¼ ì œê±°í•´ì•¼ í™”ë©´ì—ì„œ ì‚¬ë¼ì§€ì§€ ì•ŠëŠ”ë‹¤.)
                  element_wrap.style.display = 'none';

                  // ìš°í¸ë²ˆí˜¸ ì°¾ê¸° í™”ë©´ì´ ë³´ì´ê¸° ì´ì „ìœ¼ë¡œ scroll ìœ„ì¹˜ë¥¼ ë˜ëŒë¦°ë‹¤.
                  document.body.scrollTop = currentScroll;
                },
                // ìš°í¸ë²ˆí˜¸ ì°¾ê¸° í™”ë©´ í¬ê¸°ê°€ ì¡°ì •ë˜ì—ˆì„ë•Œ ì‹¤í–‰í•  ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ë¶€ë¶„. iframeì„ ë„£ì€ elementì˜ ë†’ì´ê°’ì„ ì¡°ì •í•œë‹¤.
                onresize: function (size) {
                  element_wrap.style.height = size.height + 'px';
                },
                width: '100%',
                height: '100%'
              }).embed(element_wrap);

              // iframeì„ ë„£ì€ elementë¥¼ ë³´ì´ê²Œ í•œë‹¤.
              element_wrap.style.display = 'block';
            }
          </script>

        </div>

      </form>
    </div>

  </div>
</body>

</html>