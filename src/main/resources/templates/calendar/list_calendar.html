<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">

<!-- âœ… ìŠ¤íƒ€ì¼ -->
<th:block layout:fragment="styles">
  <link rel="stylesheet" href="/css/calendar.css">
</th:block>

<div layout:fragment="content">

  <!-- âœ… ì¼ì • ëª¨ë‹¬ -->
  <div id="calendarModal" class="calendar-modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h3 id="modalTitle">ì œëª© ì—†ìŒ</h3>
      <p id="modalDate"></p>
      <div id="modalType"></div>
    </div>
  </div>

  <!-- âœ… ìƒë‹¨ ì»¨íŠ¸ë¡¤ -->
  <div class="calendar-header">
    <div class="month-controls" id="month_title" data-current_year="" data-current_month="">
      <a href="#" onclick="changeMonth(-1)">
        <img src="/images/arrow-left.png" alt="ì´ì „ë‹¬" class="arrow-icon">
      </a>
      <span id="panel_year_month">2025ë…„ 7ì›”</span>
      <a href="#" onclick="changeMonth(1)">
        <img src="/images/arrow-right.png" alt="ë‹¤ìŒë‹¬" class="arrow-icon">
      </a>
      <img src="/images/crocodile.png" class="calendar-icon" onclick="goToToday()" style="cursor: pointer;">
    </div>
    <div class="calendar-actions">
      <a href="/calendar/create" class="add-calendar-btn">â• ì¼ì • ë“±ë¡í•˜ê¸°</a>
    </div>
  </div>

  <!-- âœ… ë‹¬ë ¥ í‘œ -->
  <table>
    <thead>
      <tr>
        <th class="weekend">ì¼ìš”ì¼</th>
        <th>ì›”ìš”ì¼</th>
        <th>í™”ìš”ì¼</th>
        <th>ìˆ˜ìš”ì¼</th>
        <th>ëª©ìš”ì¼</th>
        <th>ê¸ˆìš”ì¼</th>
        <th class="saturday">í† ìš”ì¼</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- âœ… ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    function openModalByDate(date_calendar) {
      document.getElementById("modalTitle").textContent = "ğŸ“… " + date_calendar + " ì¼ì • ëª©ë¡";
      document.getElementById("modalDate").innerHTML = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
      document.getElementById("modalType").innerHTML = "";

      document.getElementById("calendarModal").style.display = "flex";

      fetch("/calendar/list_calendar_day?labeldate=" + date_calendar)
        .then(response => response.json())
        .then(data => {
          let result = "";
          if (data.length === 0) {
            result = "<p>ğŸ“­ ì¼ì • ì—†ìŒ</p>";
          } else {
            result = "<ul style='padding-left: 1em;'>";
            result += data.map(item => `
              <li>
                <a href="/calendar/read/${item.calendarno}" style="text-decoration: none; color: #333;">
                  ğŸ“Œ ${item.title || "ì œëª© ì—†ìŒ"}
                </a>
                <span class="delete-btn" onclick="deleteCalendar(${item.calendarno})" title="ì‚­ì œ">ğŸ—‘ï¸</span>
              </li>
            `).join("");
            result += "</ul>";
          }

          document.getElementById("modalDate").innerHTML = result;

          // âœ… ì¼ì • ë“±ë¡ í¼ ì‚½ì…
          document.getElementById("modalType").innerHTML = `
            <div style="margin-top: 12px; display: flex; align-items: center;">
              <input type="text" id="newScheduleTitle" placeholder="ìƒˆ ì¼ì • ì œëª©"
                     style="flex: 1; padding: 6px; border-radius: 6px; border: 1px solid #ccc; margin-right: 8px;">
              <button onclick="createSchedule('${date_calendar}')"
                      style="padding: 6px 10px; border: none; background-color: #3D7152; color: #fff; border-radius: 6px;">
                ë“±ë¡
              </button>
            </div>`;
        })
        .catch(error => {
          console.error("ì˜¤ë¥˜ ë°œìƒ:", error);
          document.getElementById("modalDate").innerText = "âŒ ì¼ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
        });
    }

    function createSchedule(labeldate) {
      const titleInput = document.getElementById("newScheduleTitle");
      const title = titleInput.value.trim();

      if (!title) {
        alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        return;
      }

      titleInput.disabled = true;

      fetch("/calendar/create", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          [document.querySelector('meta[name="_csrf_header"]').getAttribute("content")]:
            document.querySelector('meta[name="_csrf"]').getAttribute("content")
        },
        body: JSON.stringify({
          labeldate: labeldate,
          title: title,
          content: title,
          label: "ì¼ì •",
          type: "user",
          emoji: "ğŸ“Œ"
        })
      })
        .then(res => {
          if (!res.ok) throw new Error("ë“±ë¡ ì‹¤íŒ¨");
          return fetch("/calendar/list_calendar_day?labeldate=" + labeldate);
        })
        .then(res => res.json())
        .then(data => {
          let result = "<ul style='padding-left: 1em;'>";
          result += data.map(item => `
            <li>
              <a href="/calendar/read/${item.calendarno}" style="text-decoration: none; color: #333;">
                ğŸ“Œ ${item.title || "ì œëª© ì—†ìŒ"}
              </a>
              <span class="delete-btn" onclick="deleteCalendar(${item.calendarno})" title="ì‚­ì œ">ğŸ—‘ï¸</span>
            </li>
          `).join("");
          result += "</ul>";

          document.getElementById("modalDate").innerHTML = result;
          titleInput.value = "";
          titleInput.disabled = false;
        })
        .catch(err => {
          console.error("ë“±ë¡ ì¤‘ ì˜¤ë¥˜:", err);
          alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          titleInput.disabled = false;
        });
    }

    async function fetchCalendarData(date_calendar, contentDiv) {
      try {
        const response = await fetch("/calendar/list_calendar_day?labeldate=" + date_calendar);
        if (!response.ok) return;

        const data = await response.json();
        if (data.length > 0) {
          const emojiSpan = document.createElement("span");
          emojiSpan.textContent = "ğŸ“Œ";
          emojiSpan.className = "calendar-emoji";
          emojiSpan.style.fontSize = "20px";
          emojiSpan.style.cursor = "pointer";
          emojiSpan.onclick = () => openModalByDate(date_calendar);
          contentDiv.appendChild(emojiSpan);
        }
      } catch (err) {
        console.error("ì´ëª¨ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
      }
    }

    window.onload = function () {
      closeModal();
      const year = parseInt('[[${year}]]');
      const month = parseInt('[[${month}]]');

      const monthTitle = document.getElementById('month_title');
      monthTitle.setAttribute('data-current_year', year);
      monthTitle.setAttribute('data-current_month', month);

      document.getElementById("panel_year_month").textContent = `${year}ë…„ ${month + 1}ì›”`;

      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const calendarBody = document.querySelector("tbody");
      calendarBody.innerHTML = "";

      const firstDay = new Date(year, month, 1).getDay();
      let row = document.createElement("tr");
      for (let i = 0; i < firstDay; i++) row.appendChild(document.createElement("td"));

      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("td");
        const contentDiv = document.createElement("div");
        contentDiv.style.display = "flex";
        contentDiv.style.flexDirection = "column";
        contentDiv.style.alignItems = "center";

        const date_calendar = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        const dateSpan = document.createElement("span");
        dateSpan.textContent = day;
        dateSpan.style.fontWeight = "bold";
        dateSpan.onclick = () => openModalByDate(date_calendar);
        contentDiv.appendChild(dateSpan);

        // âœ… ì¼ì •ì´ ìˆì„ ë•Œë§Œ ì´ëª¨ì§€ ì¶œë ¥
        fetchCalendarData(date_calendar, contentDiv);

        cell.appendChild(contentDiv);

        if ((firstDay + day - 1) % 7 === 0) cell.classList.add("weekend");
        if ((firstDay + day - 1) % 7 === 6) cell.classList.add("saturday");
        if (year === new Date().getFullYear() && month === new Date().getMonth() && day === new Date().getDate()) {
          cell.classList.add("today");
        }

        row.appendChild(cell);
        if ((firstDay + day - 1) % 7 === 6) {
          calendarBody.appendChild(row);
          row = document.createElement("tr");
        }
      }

      if (row.children.length > 0) {
        while (row.children.length < 7) {
          row.appendChild(document.createElement("td"));
        }
        calendarBody.appendChild(row);
      }
    };

    function closeModal() {
      document.getElementById("calendarModal").style.display = "none";
    }

    window.onclick = function (event) {
      if (event.target === document.getElementById("calendarModal")) closeModal();
    }

    function changeMonth(cnt) {
      const monthTitle = document.getElementById('month_title');
      let currentYear = parseInt(monthTitle.getAttribute('data-current_year'), 10);
      let currentMonth = parseInt(monthTitle.getAttribute('data-current_month'), 10);

      currentMonth += cnt;
      if (currentMonth > 11) { currentMonth = 0; currentYear++; }
      else if (currentMonth < 0) { currentMonth = 11; currentYear--; }

      location.href = `/calendar/list_calendar?year=${currentYear}&month=${currentMonth + 1}`;
    }

    function goToToday() {
      const today = new Date();
      location.href = `/calendar/list_calendar?year=${today.getFullYear()}&month=${today.getMonth() + 1}`;
    }

    function deleteCalendar(calendarno) {
      if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ì–´ìš”?")) {
        fetch(`/calendar/delete_proc?calendarno=${calendarno}`, { method: 'GET' })
          .then(res => res.text())
          .then(result => {
            if (result == "success") {
              const date = document.getElementById("modalTitle").textContent.replace("ğŸ“… ", "").trim();
              openModalByDate(date);
              location.reload();
            } else {
              alert("â— ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          })
          .catch(err => {
            console.error("ì‚­ì œ ì˜¤ë¥˜:", err);
            alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
          });
      }
    }
  </script>
</div>
</html>
