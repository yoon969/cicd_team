<!DOCTYPE html>
<html lang="ko" layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
  <meta charset="UTF-8">
  <title>ìˆ¨ìˆ¨ì´ë“¤</title>
  <link rel="stylesheet" href="/css/post.css">
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<body th:attr="data-usersno=${usersno != null ? usersno : -1}" th:attrappend="data-postno=${postVO.postno},
                     data-hartcnt=${hartCnt},
                     data-recom=${postVO.recom},
                     data-postwriter=${postVO.usersno}">

  <div layout:fragment="content">

    <script th:inline="javascript">
      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
      const postno = document.body.dataset.postno;
      const usersno = document.body.dataset.usersno;
      const hartCnt = document.body.dataset.hartcnt;
      const recom = document.body.dataset.recom ?? 0;
      const isAdmin = /*[[${session.role == 'admin'}]]*/ false;

      let openedReplyForms = new Set();     // ë‹µê¸€ ì…ë ¥ì°½ ì—´ë¦° parentno ì €ì¥
      let expandedReplies = new Set();      // ë‹µê¸€ íŠ¸ë¦¬ í¼ì³ì§„ parentno ì €ì¥
      let editingReplyno = null;            // ìˆ˜ì • ì¤‘ì¸ ëŒ“ê¸€ ë²ˆí˜¸


      // âœ… ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§
      // âœ… ëŒ“ê¸€ ëª©ë¡ ë Œë”ë§ (ëŒ€ëŒ“ê¸€ ê³„ì¸µ í¬í•¨)
      function renderReplyList(replies) {
        const container = document.getElementById('replyBox');
        container.innerHTML = '';

        if (!replies || replies.length === 0) {
          container.innerHTML = `<div class="reply-empty">ğŸ’¬ ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
          return;
        }

        const replyMap = {};
        replies.forEach(reply => {
          replyMap[reply.replyno] = { ...reply, children: [] };
        });

        const roots = [];
        replies.forEach(reply => {
          if (reply.parentno && replyMap[reply.parentno]) {
            replyMap[reply.parentno].children.push(replyMap[reply.replyno]);
          } else {
            roots.push(replyMap[reply.replyno]);
          }
        });

        roots.forEach(reply => {
          renderReplyTree(reply, container);
        });

        hljs.highlightAll();
      }

      // âœ… ëŒ“ê¸€ 1ê°œ + ìì‹ ëŒ€ëŒ“ê¸€ë“¤ ì¬ê·€ ë Œë”ë§
      function renderReplyTree(reply, container, isChild = false) {
        const replyno = reply.replyno;
        const writerNo = parseInt(usersno);
        const replyWriterNo = parseInt(reply.usersno);
        const postWriterNo = parseInt(document.body.dataset.postwriter);  // ê²Œì‹œê¸€ ì‘ì„±ì ë²ˆí˜¸
        const isPostWriter = replyWriterNo === postWriterNo;               // ëŒ“ê¸€ ì“´ ì‚¬ëŒì´ ê²Œì‹œê¸€ ì‘ì„±ìì¸ê°€
        const usersname = isPostWriter ? 'ì‘ì„±ì' : (reply.usersname ?? 'ìµëª…');

        const profileInitial = usersname.charAt(0).toUpperCase();
        const rdate = reply.rdate ?? '';
        const liked = reply.liked ?? 0;
        const likeCount = reply.likeCount ?? 0;
        const isMine = writerNo === replyWriterNo || reply.isMine || isAdmin;

        let contentRaw = reply.content ?? '';
        const parentWriter = reply.parentWriter;

        // âœ… ë©˜ì…˜ ë¶™ì´ê¸° (ëŒ€ëŒ“ê¸€ì¼ ë•Œë§Œ)
        if (isChild && parentWriter) {
          contentRaw = `<span class="mention"></span> ${contentRaw}`;
        }

        const contentWithHighlight = contentRaw.includes("```")
          ? convertToCodeBlock(contentRaw)
          : `<p>${contentRaw.replace(/\n/g, '<br>')}</p>`;

        const likeImg = liked === 1
          ? '/post/images/hart_on_50.png'
          : '/post/images/hart_off_50.png';

        // âœ… ëŒ“ê¸€ ì „ì²´ wrapper
        const div = document.createElement('div');
        div.className = isChild ? 'reply-item reply-child' : 'reply';

        // âœ… ìƒë‹¨ (ì‘ì„±ì, ì‹œê°„ ë“±)
        div.innerHTML = `
    <div class="reply-top">
      <div class="profile-circle">${profileInitial}</div>
      <div class="author-info">
        <span class="author-name ${isPostWriter ? 'writer-badge' : ''}">${usersname}</span>
        <span class="reply-time">${rdate}</span>
      </div>
    </div>
  `;

        // âœ… ëŒ“ê¸€ ë³¸ë¬¸ (ë©˜ì…˜ í¬í•¨)
        const replyContentDiv = document.createElement("div");
        replyContentDiv.className = "reply-content";
        replyContentDiv.id = `reply_content_${replyno}`;
        replyContentDiv.innerHTML = contentWithHighlight;
        div.appendChild(replyContentDiv);

        // âœ… í‘¸í„° (ì¢‹ì•„ìš”, ìˆ˜ì •, ì‚­ì œ)
        const replyFooterDiv = document.createElement("div");
        replyFooterDiv.className = "reply-footer";
        replyFooterDiv.innerHTML = `
    <span class="btn-like" data-replyno="${replyno}">
      <img src="${likeImg}" style="width: 20px;" title="ì¢‹ì•„ìš”">
    </span>
    <span id="reply_like_count__${replyno}" class="reply-like-count">${likeCount}</span>
    ${!isChild ? `<button onclick="toggleReplyForm(${replyno}, this)">ë‹µê¸€</button>` : ''}
    ${isMine ? `
      <button onclick="showEditForm(${replyno}, \`${reply.content.replace(/`/g, '\\`')}\`)">ìˆ˜ì •</button>
      <button onclick="deleteReply(${replyno})" class="reply-delete-btn">ì‚­ì œ</button>
    ` : ''}
  `;
        div.appendChild(replyFooterDiv);
        // âœ… ë‹µê¸€ ì…ë ¥ì°½ì„ ìœ„í•œ DIV (ë¯¸ë¦¬ ìƒì„±)
        const replyFormDiv = document.createElement("div");
        replyFormDiv.id = `replyForm_${replyno}`;
        replyFormDiv.className = "reply-form";
        replyFormDiv.style.display = "none";  // ê¸°ë³¸ ìˆ¨ê¹€
        div.appendChild(replyFormDiv);

        // âœ… ìµœì¢… ëŒ“ê¸€ ì¶”ê°€
        container.appendChild(div);

        // âœ… ìì‹ ëŒ“ê¸€ ë Œë”ë§
        if (reply.children && reply.children.length > 0 && !isChild) {
          // âœ… ìì‹ ëŒ“ê¸€ì„ ë¬¶ì„ wrapper
          const childrenWrapper = document.createElement("div");
          childrenWrapper.id = `childReplies_${replyno}`;
          childrenWrapper.style.display = "none";
          childrenWrapper.className = "child-reply-wrapper";  // í•„ìš” ì‹œ ìŠ¤íƒ€ì¼ë§ìš©

          // âœ… í† ê¸€ ë²„íŠ¼
          const toggleBtn = document.createElement("button");
          toggleBtn.innerText = `ë‹µê¸€ ${reply.children.length}ê°œ â–¾`;
          toggleBtn.className = "reply-toggle-btn";
          toggleBtn.dataset.opened = "false";

          toggleBtn.dataset.replyno = reply.replyno;

          let rendered = false;

          toggleBtn.onclick = () => {
            const isVisible = toggleBtn.dataset.opened === "true";

            if (!rendered) {
              reply.children.forEach(child => {
                renderReplyTree(child, childrenWrapper, true);
              });
              rendered = true;
            }

            toggleBtn.dataset.opened = (!isVisible).toString();
            childrenWrapper.style.display = isVisible ? "none" : "block";

            if (isVisible) {
              expandedReplies.delete(reply.replyno);
            } else {
              expandedReplies.add(reply.replyno);
            }

            toggleBtn.innerText = isVisible
              ? `ë‹µê¸€ ${reply.children.length}ê°œ â–¾`
              : `ë‹µê¸€ ${reply.children.length}ê°œ â–´`;
          };


          // âœ… ë¶€ëª¨ ëŒ“ê¸€ ìš”ì†Œ(div)ì—ë§Œ ë¶™ì´ê¸°
          div.appendChild(toggleBtn);
          div.appendChild(childrenWrapper);
        }


      }

      function toggleChildReplies(replyno, button) {
        const target = document.getElementById(`childReplies_${replyno}`);
        if (!target) return;

        const isVisible = target.style.display === "block";
        target.style.display = isVisible ? "none" : "block";

        const count = target.children.length;
        button.innerText = isVisible ? `ë‹µê¸€ ${count}ê°œ â–¾` : `ë‹µê¸€ ${count}ê°œ â–´`;
      }

      function showReplyForm(parentno) {
        const formDiv = document.getElementById(`replyForm_${parentno}`);
        if (!formDiv) return;

        formDiv.innerHTML = `
          <textarea id="replyChildContent_${parentno}" class="reply-textarea" placeholder="ë‹µê¸€ ì…ë ¥ í›„ Enterë¥¼ ëˆ„ë¥´ì„¸ìš” (Shift + Enter ì¤„ë°”ê¿ˆ)"></textarea>
        `;

        formDiv.style.display = "block";
      }

      function toggleReplyForm(parentno, button) {
        const formDiv = document.getElementById(`replyForm_${parentno}`);
        if (!formDiv) return;

        const isOpen = formDiv.style.display === "block";
        if (isOpen) {
          formDiv.style.display = "none";
          formDiv.innerHTML = '';
          openedReplyForms.delete(parentno);
          if (button) button.innerText = "ë‹µê¸€";
        } else {
          formDiv.innerHTML = `
      <textarea id="replyChildContent_${parentno}" class="reply-textarea" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    `;
          formDiv.style.display = "block";
          openedReplyForms.add(parentno);
          if (button) button.innerText = "ë‹«ê¸°";
        }
      }

      function submitReplyChild(parentno) {
        const contentElem = document.getElementById(`replyChildContent_${parentno}`);
        if (!contentElem) return;

        const content = contentElem.value.trim();
        if (!content) return alert("ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”");

        fetch("/reply/create_ajax", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            [csrfHeader]: csrfToken
          },
          body: JSON.stringify({
            postno: postno,
            content: content,
            parentno: parentno
          })
        })
          .then(res => res.json())
          .then(data => {
            if (data.status === "success") {
              expandedReplies.add(parseInt(parentno));
              loadReplyList(); // ëŒ“ê¸€ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            } else {
              alert("ë“±ë¡ ì‹¤íŒ¨");
            }
          })
          .catch(err => {
            console.error("ëŒ€ëŒ“ê¸€ ë“±ë¡ ì˜¤ë¥˜:", err);
            alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
          });
      }

      // âœ… ëŒ“ê¸€ ì‚­ì œ
      function deleteReply(replyno) {
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch("/reply/delete", {
          method: "POST",
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            [csrfHeader]: csrfToken
          },
          body: new URLSearchParams({
            replyno: replyno,
            postno: postno
          })
        })
          .then(res => res.text())
          .then(data => {
            if (data === "1") {
              alert("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
              loadReplyList(); // ìƒˆë¡œê³ ì¹¨
            } else if (data === "-1") {
              alert("ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
            } else {
              alert("ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨!");
            }
          })
          .catch(err => {
            console.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
            alert("ì„œë²„ ì˜¤ë¥˜");
          });
      }

      // ğŸš¨[â‹¯ ë²„íŠ¼ í´ë¦­ ì‹œ ë©”ë‰´ ì—´ê¸°/ë‹«ê¸°]
      function toggleMenu(button) {
        const dropdown = button.nextElementSibling;
        if (!dropdown || !dropdown.classList.contains("menu-dropdown")) {
          console.warn("â— ë“œë¡­ë‹¤ìš´ ìš”ì†Œê°€ ì—†ì–´ìš”.");
          return;
        }

        document.querySelectorAll(".menu-dropdown").forEach(el => {
          if (el !== dropdown) el.style.display = "none";
        });

        dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
      }

      function showEditForm(replyno, oldContent) {
        editingReplyno = replyno;
        const contentDiv = document.getElementById(`reply_content_${replyno}`);
        const replyFooter = contentDiv?.nextElementSibling;

        // âœ… ê¸°ì¡´ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        if (replyFooter) {
          replyFooter.style.display = "none";
        }
        contentDiv.innerHTML = `
    <textarea id="edit_input_${replyno}" class="reply-textarea">${oldContent}</textarea>
    <div style="margin-top: 6px;">
      <button onclick="submitEdit(${replyno})" class="btn btn-filled">ìˆ˜ì • ì™„ë£Œ</button>
      <button onclick="cancelEdit(${replyno})" class="btn btn-outline">ì·¨ì†Œ</button>
    </div>
  `;
      }

      function submitEdit(replyno) {
        const textarea = document.querySelector(`#edit_input_${replyno}`);
        const content = textarea.value.trim();  // âœ… textarea ê°’ ì¶”ì¶œ

        if (!content) {
          alert("ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        fetch("/reply/update", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            [csrfHeader]: csrfToken
          },
          body: JSON.stringify({ replyno, content })
        })
          .then(response => response.text())
          .then(data => {
            if (data === "success") {
              alert("ëŒ“ê¸€ ìˆ˜ì • ì„±ê³µ!");
              editingReplyno = null;
              loadReplyList();
            } else {
              alert("ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨!");
            }
          });
      }


      // âœ… ëŒ“ê¸€ ë“±ë¡
      function addReply() {
        const content = document.getElementById('replyContent').value.trim();
        if (!content) return alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”");

        fetch("/reply/create_ajax", {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
          },
          body: JSON.stringify({ postno: postno, content: content })
        })
          .then(res => res.json())
          .then(data => {
            if (data.status === "success") {
              loadReplyList();
              document.getElementById('replyContent').value = '';
            } else {
              alert("ë“±ë¡ ì‹¤íŒ¨: " + (data.msg || "ì„œë²„ ì˜¤ë¥˜"));
            }
          })
          .catch(err => {
            console.error("Ajax ì˜¤ë¥˜:", err);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
          });
      }

      // âœ… ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
      function loadReplyList() {
        fetch(`/reply/list_json/${postno}`)
          .then(res => res.json())
          .then(data => {
            renderReplyList(data);

            // âœ… ì—´ë ¤ìˆë˜ ë‹µê¸€ ì…ë ¥ì°½ ë‹¤ì‹œ ì—´ê¸°
            openedReplyForms.forEach(parentno => {
              toggleReplyForm(parseInt(parentno));
            });

            // âœ… í¼ì³ì§„ ëŒ€ëŒ“ê¸€ íŠ¸ë¦¬ ë‹¤ì‹œ ì—´ê¸°
            expandedReplies.forEach(parentno => {
              const toggleBtn = document.querySelector(
                `.reply-toggle-btn[data-replyno="${parentno}"]`
              );
              if (toggleBtn && toggleBtn.dataset.opened === "false") {
                toggleBtn.click(); // íŠ¸ë¦¬ ì—´ê¸°
              }
            });

            // âœ… ìˆ˜ì • ì¤‘ ëŒ“ê¸€ ë³µì›
            if (editingReplyno) {
              const content = data.find(r => r.replyno === editingReplyno)?.content ?? '';
              showEditForm(editingReplyno, content);
            }
          })
          .catch(err => {
            console.error("ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
          });
      }

      // âœ… ì¢‹ì•„ìš” í† ê¸€
      let isProcessing = false;
      function toggleLike(replyno) {
        if (isProcessing) return;
        isProcessing = true;

        if (!usersno || usersno === 'null' || isNaN(parseInt(usersno))) {
          alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”!");
          isProcessing = false;
          return;
        }

        fetch("/replylike/toggle", {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
          },
          body: JSON.stringify({ replyno: replyno, usersno: parseInt(usersno) })
        })
          .then(res => res.json())
          .then(data => {
            const imgSrc = data.status === "liked"
              ? "/post/images/hart_on_50.png"
              : "/post/images/hart_off_50.png";

            const likePanel = document.querySelector(`.btn-like[data-replyno='${replyno}']`);
            const likeCount = document.getElementById(`reply_like_count__${replyno}`);

            if (likePanel && likeCount) {
              likePanel.innerHTML = `<img src="${imgSrc}" style="width: 20px;" title="ì¢‹ì•„ìš”">`;
              likeCount.innerText = data.likeCount !== undefined && data.likeCount !== null ? data.likeCount : 0;
            }

            isProcessing = false;
          })
          .catch(err => {
            console.error("ëŒ“ê¸€ ì¢‹ì•„ìš” í† ê¸€ ì˜¤ë¥˜:", err);
            isProcessing = false;
          });
      }

      // âœ… ì¢‹ì•„ìš” ì´ë²¤íŠ¸ ìœ„ì„
      document.addEventListener("click", function (e) {
        const btn = e.target.closest(".btn-like");
        if (!btn) return;
        const replyno = btn.dataset.replyno;
        toggleLike(replyno);
      });

      // âœ… ì½”ë“œë¸”ëŸ­ ë³€í™˜ í•¨ìˆ˜
      function convertToCodeBlock(text) {
        const regex = /```(\w*)\n([\s\S]*?)```/g;
        return text.replace(regex, (match, lang, code) => {
          return `<pre><code class="language-${lang}">${escapeHTML(code)}</code></pre>`;
        });
      }

      function escapeHTML(str) {
        return str.replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function renderPostLikeButton() {
        const hartPanel = document.getElementById('hart_panel');
        if (!hartPanel) return;

        const liked = reply.liked ?? reply.LIKED ?? false;
        const imageSrc = isLiked
          ? '/post/images/hart_on_50.png'
          : '/post/images/hart_off_50.png';

        hartPanel.innerHTML = `
    <span id="btn_post_like" style="cursor: pointer;">
      <img src="${imageSrc}" style="width: 24px;" title="ì¢‹ì•„ìš”">
    </span>
  `;
      }

      function togglePostLike() {
        if (!usersno || usersno === 'null' || isNaN(parseInt(usersno))) {
          alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”!");
          return;
        }

        fetch("/post/good", {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
          },
          body: JSON.stringify({ postno: parseInt(postno), usersno: parseInt(usersno) })
        })
          .then(res => res.json())
          .then(data => {
            const imgSrc = data.hartCnt === 1
              ? "/post/images/hart_on_50.png"
              : "/post/images/hart_off_50.png";

            // ì¢‹ì•„ìš” í•˜íŠ¸ ì´ë¯¸ì§€
            const likeImage = document.getElementById("postlike_img");
            if (likeImage) {
              likeImage.src = imgSrc;
            }

            // ì¶”ì²œ ìˆ˜ë§Œ ì—…ë°ì´íŠ¸ (recom_countë§Œ ê°±ì‹ )
            const recomCountSpan = document.getElementById("recom_count");
            if (recomCountSpan) {
              recomCountSpan.innerText = data.recom ?? 0;
            }

            // ë°ì´í„°ì…‹ë„ ê°±ì‹ 
            document.body.dataset.hartcnt = data.hartCnt;
          })

          .catch(err => {
            console.error("ê²Œì‹œê¸€ ì¢‹ì•„ìš” í† ê¸€ ì˜¤ë¥˜:", err);
            alert("ì„œë²„ ì˜¤ë¥˜ë¡œ ì¢‹ì•„ìš” ì²˜ë¦¬ë¥¼ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          });
      }

      // âœ… ìµœì´ˆ ì‹¤í–‰
      window.onload = function () {
        loadReplyList();

        // ë³¸ ëŒ“ê¸€ ë“±ë¡ (Enter â†’ ë“±ë¡)
        const replyContent = document.getElementById("replyContent");
        if (replyContent) {
          replyContent.addEventListener("keydown", function (event) {
            if (event.key === "Enter" && !event.shiftKey) {
              event.preventDefault();
              addReply();
            }
          });
        }

        // âœ… ëŒ€ëŒ“ê¸€(ë‹µê¸€) ë“±ë¡ (Enter â†’ ë“±ë¡, Shift+Enter ì¤„ë°”ê¿ˆ)
        document.addEventListener("keydown", function (e) {
          const target = e.target;
          if (target.classList.contains("reply-textarea") && target.id.startsWith("replyChildContent_")) {
            if (e.key === "Enter" && !e.shiftKey) {
              e.preventDefault();
              const parentno = target.id.split("_")[1];
              submitReplyChild(parentno);
            }
          }
        });
      };

      function cancelEdit(replyno) {
        editingReplyno = null;
        loadReplyList(); // ì›ë˜ ëŒ“ê¸€ ëª©ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
      }

    </script>

    <fieldset class="fieldset_basic">
      <div class="container_read">
        <!-- âœ… í—¤ë” ìƒë‹¨ í†µí•© -->
        <div class="header-top">
          <div class="title_line">
            <span th:text="${speciesVO.grp}">ëŒ€ë¶„ë¥˜</span>
            &gt;
            <span th:text="${speciesVO.sname}">ì¤‘ë¶„ë¥˜</span>
          </div>

          <aside class="aside_right">
            <a href="javascript:location.reload();">ìƒˆë¡œê³ ì¹¨</a>
            <span class='menu_divide'>â”‚</span>
            <a th:if="${fromSearch}" th:href="@{|/post/search?word=${word}&now_page=${nowPage}|}">ê²€ìƒ‰ ê²°ê³¼ë¡œ</a>
            <a th:if="${!fromSearch}" th:href="@{/post/list(speciesno=${postVO.speciesno})}">ëª©ë¡</a>

            <th:block th:if="${usersno != null and (session.role == 'admin' or usersno == postVO.usersno)}">
              <span class='menu_divide'>â”‚</span>
              <a th:href="@{/post/update(postno=${postVO.postno})}">ìˆ˜ì •</a>
              <span class='menu_divide'>â”‚</span>
              <a th:href="@{/post/delete(postno=${postVO.postno})}">ì‚­ì œ</a>
            </th:block>
          </aside>
        </div>


        <ul class="li_none">
          <!-- âœ… ì œëª© + ì‘ì„±ì -->
          <div class="post-header">
            <h2 th:text="${postVO.title}">ì œëª©</h2>
            <p><b>ì‘ì„±ì:</b> <span th:text="${postVO.nickname}">ì‘ì„±ì</span></p>
          </div>

          <!-- âœ… ë³¸ë¬¸ ë‚´ìš© -->
          <div th:if="${postVO.content != null and postVO.content.trim().length() > 0}">
            <div id="postContent" th:text="${postVO.content}">ë‚´ìš©</div>
          </div>
          <div th:if="${postVO.content == null or postVO.content.trim().length() == 0}"
            style="text-align:center; color:gray;">
            ğŸ“„ ì‘ì„±í•œ ë³¸ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤
          </div>

          <!-- âœ… ì´ë¯¸ì§€ -->
          <div th:if="${postVO.file1saved != null and postVO.file1saved != ''}">
            <img th:src="@{/contents/storage/{file}(file=${postVO.file1saved})}" alt="ì²¨ë¶€ ì´ë¯¸ì§€" class="img-wrapper">
          </div>
          <div th:if="${postVO.file1saved == null or postVO.file1saved == ''}" style="text-align:center; color:gray;">
            ğŸ“· ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤
          </div>

            <!-- âœ… ìœ íŠœë¸Œ -->
            <li th:if="${postVO.youtube != null and postVO.youtube.length() > 0}">
              <div class="youtube-wrapper" th:utext="${postVO.youtube}"></div>
            </li>
            <li th:if="${postVO.youtube == null or postVO.youtube.length() == 0}">
              <div style="text-align:center; color:gray;">ğŸ“¹ ì—…ë¡œë“œí•œ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤</div>
            </li>
  
            <!-- âœ… ì§€ë„ -->
            <li th:if="${postVO.map != null and postVO.map.length() > 0}">
              <div class="map-wrapper" th:utext="${postVO.map}"></div>
            </li>
            <li th:if="${postVO.map == null or postVO.map.length() == 0}">
              <div style="text-align:center; color:gray;">ğŸ—ºï¸ ì—…ë¡œë“œí•œ ì§€ë„ê°€ ì—†ìŠµë‹ˆë‹¤</div>
            </li>

          <!-- âœ… ë‹¤ìš´ë¡œë“œ + ì¢‹ì•„ìš” -->
          <div style="display:flex; align-items:center; gap: 15px;">
            <a class="download-btn"
              th:href="@{|/download?dir=contents/storage&filename=${postVO.file1saved}&downname=${postVO.file1}|}">
              <img src="/post/images/download.png" alt="ë‹¤ìš´ë¡œë“œ">
              <span th:text="${postVO.file1}">ë‹¤ìš´ë¡œë“œ</span>
            </a>

            <!-- ì¢‹ì•„ìš” í•˜íŠ¸ + ì¶”ì²œ ìˆ˜ -->
            <div class="recom-box">
              <span id="postlike_img_wrapper" style="cursor: pointer;" onclick="togglePostLike()">
                <img id="postlike_img"
                  th:src="@{${hartCnt > 0} ? '/post/images/hart_on_50.png' : '/post/images/hart_off_50.png'}"
                  style="width: 22px;" alt="ì¢‹ì•„ìš”">
              </span>
              <span class="btn-postlike" onclick="togglePostLike()" style="cursor: pointer;">
                (<span id="recom_count" th:text="${postVO.recom}">0</span>)
              </span>
            </div>

          </div>


          <!-- âœ… í‚¤ì›Œë“œ -->
          <div>
            <span id="keywordBox" th:text="${#strings.arrayJoin(keywords, ', ')}">ì—†ìŒ</span>
          </div>

          <!-- âœ… ëŒ“ê¸€ ì˜ì—­ -->
          <div class="reply-section">
            <h3 class="reply-title">ğŸ’¬ ëŒ“ê¸€</h3>

            <div class="reply-input-box">
              <textarea id="replyContent" class="reply-textarea" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>


            <div id="replyBox" class="reply-box">
              <!-- JSë¡œ ëŒ“ê¸€ ë™ì  ì¶œë ¥ -->
            </div>
          </div>
        </ul>
      </div>
    </fieldset>
  </div>
</body>

</html>