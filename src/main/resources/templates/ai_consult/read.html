<!DOCTYPE html>
<html lang="ko" layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ìƒë‹´ ìƒì„¸</title>
  <meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_header" th:content="${_csrf.headerName}">
<th:block layout:fragment="styles">
  <link rel="stylesheet" th:href="@{/css/ai_consult_list.css}">
</th:block>
<script>
window.onload = function () {
  const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

  const btn = document.getElementById('btn-similar');
  if (!btn) return;

  btn.addEventListener('click', function () {
  const consultno = parseInt(btn.getAttribute('data-consultno'));
  if (!consultno) {
    alert("consultnoê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  // ğŸ”„ ë¡œë”© ì‹œì‘
document.getElementById('similar-loading').style.display = 'block';
document.getElementById('similar-box').style.display = 'none';

  fetch('/ai_consult/similar', {
    method: 'POST',
    headers: {'Content-Type': 'application/json',
    [csrfHeader]: csrfToken },
    body: JSON.stringify({ consultno: consultno })
  })
  .then(res => res.json())
  .then(data => {
    let html = '<div class="similar-title">ğŸ” ìœ ì‚¬ ìƒë‹´ ê²°ê³¼</div>';
    if (data && data.length > 0) {
      html += '<ul>';
      data.forEach(item => {
        html += `<li>
          <b>Q.</b> ${item.question}<br>
          <b>A.</b> ${item.answer}<br>
          <span style="color:#888">í‚¤ì›Œë“œ: ${item.symptom_tags}</span><br>
          <span style="color:#007b00">ğŸ” ìœ ì‚¬ë„: ${(item.similarity * 100).toFixed(1)}%</span>
        </li>`;
      });
      html += '</ul>';
    } else {
      html += '<span>ìœ ì‚¬ ìƒë‹´ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
    }

    // â¹ ë¡œë”© ì¢…ë£Œ
document.getElementById('similar-loading').style.display = 'none';
document.getElementById('similar-box').style.display = 'block';
    document.getElementById('similar-box').innerHTML = html;
  })
  .catch(() => {
    document.getElementById('similar-loading').style.display = 'none';
    document.getElementById('similar-box').style.display = 'block';
    document.getElementById('similar-box').innerHTML = '<span>ìœ ì‚¬ ìƒë‹´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</span>';
  });
});
};
</script>
</head>
<body>
  <div layout:fragment="content" class="consult-read-container">
    <div class="consult-title">ğŸ“ ìƒë‹´ ìƒì„¸</div>

    <div class="consult-field">
      <span class="consult-label">ì§ˆë¬¸</span>
      <span class="consult-value" th:text="${vo.question}"></span>
    </div>
    <div class="consult-field">
      <span class="consult-label">ë‹µë³€</span>
      <span class="consult-value" th:text="${vo.answer}"></span>
    </div>
    <div class="consult-field">
      <span class="consult-label">í‚¤ì›Œë“œ</span>
      <span class="consult-value" th:text="${vo.symptom_tags}"></span>
    </div>
    <div class="consult-field">
      <span class="consult-label">ì¶œì²˜</span>
      <span class="consult-value" th:text="${vo.source_type}"></span>
    </div>
    <div class="consult-field" th:if="${vo.summary != null}">
      <span class="consult-label">ìš”ì•½</span>
      <span class="consult-value" th:text="${vo.summary}"></span>
    </div>


    <div class="consult-btns">
      <a th:href="@{/ai_consult/list}" class="navbar-btn">ëª©ë¡</a>
      <button type="button" class="navbar-btn" id="btn-similar"
        th:attr="data-consultno=${vo.consultno}">
  ìœ ì‚¬ ìƒë‹´ ë³´ê¸°
</button>
    </div>

<!-- ğŸ”„ ìœ ì‚¬ ìƒë‹´ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ -->
<div id="similar-loading" style="text-align:center; display:none;">
  <img src="/images/progress.gif" alt="ë¡œë”©ì¤‘" style="width:5%;">
</div>

    <!-- ìœ ì‚¬ ìƒë‹´ ê²°ê³¼ ì¶œë ¥ -->
    <div id="similar-box" class="similar-box"></div>
  </div>


</body>
</html>
