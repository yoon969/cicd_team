<!DOCTYPE html>
<html lang="ko" layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>AI ìƒë‹´í•˜ê¸°</title>

  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">

  <th:block layout:fragment="styles">
    <link rel="stylesheet" href="/css/ai_consult.css">

  </th:block>

  <script>
    let lastQuestion = '';
    let lastAnswer = '';
    let lastSymptomTags = '';
    let lastSourceType = '';

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    function sendQuestion() {
      const input = document.getElementById('question');
      const chatBox = document.getElementById('chatBox');
      const message = input.value.trim();

      if (!message) return;

      lastQuestion = message;

      const userMsg = document.createElement('div');
      userMsg.className = 'chat-msg user';
      userMsg.textContent = message;
      chatBox.appendChild(userMsg);

      input.value = '';
      chatBox.scrollTop = chatBox.scrollHeight;

      const loadingMsg = document.createElement('div');
      loadingMsg.className = 'chat-msg loading';
      loadingMsg.textContent = 'AIê°€ ë‹µë³€ ì¤‘ì…ë‹ˆë‹¤...';
      chatBox.appendChild(loadingMsg);

      fetch('/ai_consult/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          [csrfHeader]: csrfToken
        },
        body: JSON.stringify({ question: message })
      })
        .then(res => res.json())
        .then(data => {
          const loadingElement = document.querySelector('.chat-msg.loading');
          if (loadingElement) loadingElement.remove();

          const result = data.result || {};
          const answer = result.answer || 'AI ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆì–´ìš” ğŸ˜¢';
          const symptomTags = result.symptom_tags || '';
          const sourceType = result.source_type || 'GPT';

          const aiMsg = document.createElement('div');
          aiMsg.className = 'chat-msg ai';
          aiMsg.innerHTML = `
            <div class="ai-box">
              <div class="ai-label">ğŸ¤– AIì˜ ë‹µë³€</div>
              <div class="ai-answer">${answer}</div>
              ${symptomTags ? `<div class="ai-meta">ğŸ§  í‚¤ì›Œë“œ: ${symptomTags}</div>` : ''}
              ${sourceType ? `<div class="ai-meta">ğŸ“š ì¶œì²˜: ${sourceType}</div>` : ''}
            </div>
          `;
          chatBox.appendChild(aiMsg);

          lastAnswer = answer;
          lastSymptomTags = symptomTags;
          lastSourceType = sourceType;

          chatBox.scrollTop = chatBox.scrollHeight;
        })
        .catch(err => {
          const loadingElement = document.querySelector('.chat-msg.loading');
          if (loadingElement) loadingElement.remove();

          const errorMsg = document.createElement('div');
          errorMsg.className = 'chat-msg ai';
          errorMsg.textContent = 'ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
          chatBox.appendChild(errorMsg);
        });
    }

    function saveLastQA() {
      if (!lastQuestion || !lastAnswer) {
        alert('ì €ì¥í•  ì§ˆë¬¸ê³¼ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      fetch('/ai_consult/summary', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          [csrfHeader]: csrfToken
        },
        body: JSON.stringify({
          content: "Q: " + lastQuestion + "\nA: " + lastAnswer
        })
      })
        .then(res => res.json())
        .then(summaryData => {
          fetch('/ai_consult/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              [csrfHeader]: csrfToken
            },
            body: JSON.stringify({
              question: lastQuestion,
              answer: lastAnswer,
              symptom_tags: lastSymptomTags,
              source_type: lastSourceType,
              summary: summaryData.summary || '',
              emotion: summaryData.emotion ?? -1
            })
          })
            .then(res => {
              if (res.status === 409) {
                alert('ì´ë¯¸ ì €ì¥ëœ ìƒë‹´ ë‚´ìš©ì…ë‹ˆë‹¤.');
                return;
              }
              if (!res.ok) {
                alert('ì €ì¥ ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜');
                return;
              }
              alert('ìƒë‹´ + ìš”ì•½ ì €ì¥ ì™„ë£Œ!');
            })
            .catch(err => {
              alert('ì €ì¥ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            });
        })
        .catch(err => {
          alert("FastAPI ìš”ì•½ ì‹¤íŒ¨: " + err.message);
        });
    }

    window.onload = () => {
      const input = document.getElementById('question');
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendQuestion();
        }
      });
    };
  </script>
</head>

<body>
  <div layout:fragment="content" class="chat-container">
    <div class="chat-title">ğŸ’¬ ìˆ¨ìˆ¨ì´ AI ìƒë‹´</div>

    <div class="chat-box" id="chatBox">
      <!-- ëŒ€í™” ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
    </div>

    <div class="chat-input">
      <input type="text" id="question" placeholder="ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•´ë³´ì„¸ìš”..." />
      <button onclick="sendQuestion()" class="navbar-btn">ì „ì†¡</button>
      <button onclick="saveLastQA()" class="navbar-btn">ì €ì¥í•˜ê¸°</button>
    </div>
  </div>
</body>

</html>
