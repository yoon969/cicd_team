<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ë³‘ì› ì¶”ì²œ ë°›ê¸°</title>
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">
<th:block layout:fragment="styles">
  <link rel="stylesheet" href="/css/hospital_recommend.css">
</th:block>

  <script>
window.onload = () => {
  const locationInput = document.getElementById("location");
  const animalInput = document.getElementById("animal");
  const sendBtn = document.getElementById("send");
  const saveBtn = document.getElementById("save");
  const resultDiv = document.getElementById("result");
  const resultAnimation = document.getElementById("result_animation");
const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
  let lastResult = [];

  // âŒ¨ï¸ ì§€ì—­ ì…ë ¥ í›„ Enter ëˆ„ë¥´ë©´ ìˆ¨ìˆ¨ì´ ì…ë ¥ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
  locationInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      animalInput.focus();
    }
  });

  // ì¶”ì²œ ë²„íŠ¼ í´ë¦­
  sendBtn.addEventListener("click", () => {
    const location = locationInput.value.trim();
    const animal = animalInput.value.trim();

    if (!location || !animal) {
      alert("ì§€ì—­ê³¼ ìˆ¨ìˆ¨ì´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      return;
    }

    resultDiv.style.display = 'none';
    resultAnimation.style.display = 'block';

    fetch("/hospital/recommend", {
      method: "POST",
      headers: {'Content-Type': 'application/json',
      [csrfHeader]: csrfToken },
      body: JSON.stringify({
        query: location + " ë™ë¬¼ë³‘ì›",
        animal: animal
      })
    })
    .then(res => res.json())
    .then(data => {
      const result = Array.isArray(data) ? data : (data.result || []);
      lastResult = result;

      if (result.length === 0) {
        resultDiv.innerHTML = "<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¢</p>";
        resultDiv.style.display = 'block';
        resultAnimation.style.display = 'none';
        return;
      }

      let html = "<div class='container'>";
      result.forEach(item => {
        html += `
          <div class="card mt-2 p-2 text-start">
            <h5>${item.name}</h5>
            <p><strong>ì£¼ì†Œ:</strong> ${item.address}</p>
            <p><strong>ì „í™”:</strong> ${item.tel}</p>
            <p><strong>í™ˆí˜ì´ì§€:</strong> <a href="${item.homepage}" target="_blank">${item.homepage}</a></p>
          </div>
        `;
      });
      html += "</div>";

      resultDiv.innerHTML = html;
      resultDiv.style.display = 'block';
      resultAnimation.style.display = 'none';
    })
    .catch(err => {
      alert("FastAPI í˜¸ì¶œ ì‹¤íŒ¨: " + err.message);
      resultAnimation.style.display = 'none';
    });
  });
};
</script>
</head>

<body>
<div layout:fragment="content" class="recommend-container">

    <h2 class="title_line">ğŸ” íŠ¹ìˆ˜ë™ë¬¼ ë³‘ì› ì¶”ì²œ ë°›ê¸°</h2>

    <!-- âœ… ì§€ì—­ ì…ë ¥ -->
    <div class="form-group">
      <label for="location"><strong>ğŸ“ ì§€ì—­</strong></label>
      <input type="text" id="location" placeholder="ì˜ˆ: ì¢…ê°ì—­" size="15">
    </div>

    <!-- âœ… ìˆ¨ìˆ¨ì´ ì…ë ¥ -->
    <div class="form-group">
      <label for="animal"><strong>ğŸ¾ ì§„ë£Œê°€ í•„ìš”í•œ ìˆ¨ìˆ¨ì´</strong></label>
      <input type="text" id="animal" placeholder="ì˜ˆ: ë„ë§ˆë±€" size="15">
    </div>

    <!-- âœ… ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ì •ë ¬) -->
    <div class="button-wrapper">
      <button id="send" class="navbar-btn">ë³‘ì› ì¶”ì²œ ë°›ê¸°</button>
    </div>
    
    <!-- âœ… ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ (ì¤‘ì•™ ì •ë ¬) -->
    <div id="result_animation" class="center-animation">
      <img src="/images/progress.gif" style="width: 26px;">
    </div>

    <!-- âœ… ê²°ê³¼ ì¶œë ¥ -->
    <div id="result" style="margin-top: 20px;"></div>

  </div> <!-- /card -->



</body>

</html>
