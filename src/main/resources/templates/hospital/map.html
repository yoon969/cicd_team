<!DOCTYPE html>
<html lang="ko" layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<head>
<!-- ìˆ¨ìˆ¨ì´ë“¤ ë³‘ì› ì§€ë„ í…Œë§ˆ -->
<link rel="stylesheet" href="/css/hospital_map.css">

  <meta charset="UTF-8">
  <title>ì£¼ë³€ ë™ë¬¼ë³‘ì› ì°¾ê¸°</title>

  <!-- âœ… Kakao Maps JS SDK -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=e6250ce3219e0f6e365ccf6ec89361a3&autoload=true&libraries=services"></script>
<script>
  function createOverlay(place, map) {
    const content = document.createElement('div');
    content.className = 'custom-overlay';
    content.innerHTML = `
      <div class="title">${place.place_name}</div>
      <div>ğŸ“ ${place.road_address_name || place.address_name}</div>
      <div>â˜ï¸ ${place.phone || 'ì „í™”ë²ˆí˜¸ ì—†ìŒ'}</div>
      <a href="${place.place_url}" target="_blank">ğŸ”— ì¹´ì¹´ì˜¤ë§µì—ì„œ ë³´ê¸°</a>
    `;

    const overlay = new kakao.maps.CustomOverlay({
      content: content,
      position: new kakao.maps.LatLng(place.y, place.x),
      xAnchor: 0.5,
      yAnchor: 1.1
    });

    let hideTimer;

    // ì˜¤ë²„ë ˆì´ ë‚´ë¶€ ì§„ì… ì‹œ íƒ€ì´ë¨¸ ì œê±°
    content.addEventListener("mouseenter", () => {
      clearTimeout(hideTimer);
    });

    // ì˜¤ë²„ë ˆì´ì—ì„œ ë²—ì–´ë‚˜ë©´ ì¼ì • ì‹œê°„ í›„ ë‹«ê¸°
    content.addEventListener("mouseleave", () => {
      hideTimer = setTimeout(() => overlay.setMap(null), 10);
    });

    return {
      overlay,
      show: () => overlay.setMap(map),
      hideDelayed: () => {
        hideTimer = setTimeout(() => overlay.setMap(null), 10);
      }
    };
  }

  function searchNearby(lat, lng, map) {
    const ps = new kakao.maps.services.Places();

    ps.keywordSearch('ë™ë¬¼ë³‘ì›', function(result, status) {
      if (status === kakao.maps.services.Status.OK) {
        for (let i = 0; i < result.length; i++) {
          const place = result[i];

          const marker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(place.y, place.x)
          });

          const { overlay, show, hideDelayed } = createOverlay(place, map);

          kakao.maps.event.addListener(marker, 'mouseover', show);
          kakao.maps.event.addListener(marker, 'mouseout', hideDelayed);
        }
      }
    }, {
      location: new kakao.maps.LatLng(lat, lng),
      radius: 5000
    });
  }

  window.onload = function () {
    navigator.geolocation.getCurrentPosition(function (position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      const map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(lat, lng),
        level: 5
      });

      new kakao.maps.Marker({
        position: new kakao.maps.LatLng(lat, lng),
        map: map
      });

      searchNearby(lat, lng, map);
    }, function () {
      alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ì–´ ê¸°ë³¸ ìœ„ì¹˜ë¡œ í‘œì‹œë©ë‹ˆë‹¤.");

      const defaultLat = 37.5665, defaultLng = 126.9780;
      const map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(defaultLat, defaultLng),
        level: 5
      });

      new kakao.maps.Marker({
        position: new kakao.maps.LatLng(defaultLat, defaultLng),
        map: map
      });

      searchNearby(defaultLat, defaultLng, map);
    });
  };
</script>

</head>

<body>
<main layout:fragment="content" class="container_main">

  <h2 class="title_line">ğŸ“ ë‚´ ì£¼ë³€ ë™ë¬¼ë³‘ì›</h2>
  <div id="map"></div>
</main>


</body>
</html>
